/*  ======================================================================
        NOTE:   Here are links to helpful documentation if you'd like to fully
                understand the following code and, perhaps, add to it.
        ======================================================================
        Topic:  Error, IfError, IsError, IsBlankOrError functions:
                https://learn.microsoft.com/en-us/power-platform/power-fx/reference/function-iferror
        ======================================================================
        Topic:  Errors function
                https://learn.microsoft.com/en-us/power-platform/power-fx/reference/function-errors
        ======================================================================
        Topic: Power Fx Error handling
                https://learn.microsoft.com/en-us/power-platform/power-fx/error-handling
        // ================================================================ */
        /* =====================================================================

            NOTE:   Please follow the instructions below to finalize the
                    "installation" of this useful snippet of code to your
                    Power Apps application.

                Please be sure to add the Office365Outlook connector!

                    Any global variables created here to make this code to
                    work should be moved to App.Formulas.

                IMPORTANT: Email recipients must not include end users in
                     production without consent. It is strongly suggested to
                     use a shared support mailbox instead of personal emails.

            ===================================================================
            DEDUPLICATION FEATURE (v2.2)
            ===================================================================
            This version prevents email spam by:
            - Only sending ONE email per unique error signature per session
            - Tracking occurrence COUNT for each unique error
            - Each email includes a FULL SESSION REPORT showing ALL unique
              errors and how many times each has occurred
            - Includes detailed error kind descriptions from fxErrorKinds
            - Signature = Screen + Kind + Source + First 100 chars of Message
            ===================================================================

        ===================================================================== */
        /* ===================================================================
            VARIABLE 0 fxEnableErrorEmailNotifications
            ===================================================================
            USE:        Boolean flag to enable or disable email notifications.
                        This should be enabled only after confirming organizational
                        policy and connector availability.
            STEP #1:    Copy the code to App.Formulas
                        fxEnableErrorEmailNotifications = false;
            STEP #2:    Set it to true when you are ready to receive emails.
        =================================================================== */
        /* ===================================================================
            VARIABLE 1 fxErrorHandlerEmail
            ===================================================================
            USE:        The email address you'd like to be notified of the
                        errors that might occur in this application.
                        If you'd like multiple developers to be emailed,
                        include them all in the string and simply separate
                        them with semicolons as shown below
                        Example: "jon@domain.com;lisa@domain.com"
            STEP #1:    Change the email address below to your email address
                        or the person who will be responsible for supporting
                        this application!
            STEP #2:    Copy the code to App.Formulas
                        fxErrorHandlerEmail = "YOUR_EMAIL_HERE";
            STEP #3:    Delete or comment out the use of the Set() function
        =================================================================== */
        Set(fxErrorHandlerEmail, ";" & User().Email);                           // Put your email address before the semicolon (;)
        // ==================================================================
        //
        /* ===================================================================
            VARIABLE 2 fxApplicationName
            ==================================================================
            USE:        The name of the application to be used to let the
                        developer know which app the Error(s) came from.
            STEP #1:    Change the name in the string below to reflect the
                        actual name of this application.
            STEP #2:    Copy the code to App.Formulas
                        fxApplicationName = "The Power Apps Application";
            STEP #3:    Delete or comment out the use of the Set() function
        =================================================================== */
        Set(fxApplicationName, "The Power Apps Application");
        // ==================================================================
        //
        /* ===================================================================
            VARIABLE 3 fxApplicationURL
            ==================================================================
            USE:        The URL of this application. We use this to link back
                        to this App.
            OPTION #1:  If you'd like to link to the app to play it as a user
                        would, go to https://make.powerapps.com/ and find
                        this app listed there. Click on the 3 vertical dots,
                        and click on "Details" to copy the app link from.
                        Replace this: "https://apps.powerapps.com/"
                        ...with that URL.
                        The URL will look something like this:
                        https://apps.powerapps.com/play/e/12345efb-ce00-e9be-9b13-42284f521909/a/12345dd2-33c6-43c8-9d4e-96e6bd55b914?tenantId=12345526-320f-46bb-8838-a0626db4c5e2&sourcetime=9921603599236
            OPTION #2:  If you'd like to link to back here to Power Apps
                        studio to easily edit the app, simply copy the URL
                        you have listed above in your browser and
                        Replace this: "https://apps.powerapps.com/"
                        ...with that URL.
                        The URL will look something like this:
                        https://make.powerapps.com/e/12345efb-ce00-e9be-9b13-55284f521909/canvas?referrer=AppsPage&action=edit&form-factor=tablet&app-id=%2Fproviders%2FMicrosoft.PowerApps%2Fapps%2F5fe123d2-33c6-43c8-9d4e-1236bd55b914
            ==================================================================
            STEP #1:    Pick one of the two options outlined above and update
                        the link below.
            STEP #2:    Copy the code to App.Formulas
                        fxApplicationURL = "https://apps.powerapps.com/";
            STEP #3:    Delete or comment out the use of the Set() function
        =================================================================== */
        Set(
            fxApplicationURL,
            "https://apps.powerapps.com/"
        );
        // ==================================================================
        //
        /* ===================================================================
            VARIABLE 4 fxLightGrayColor
            ==================================================================
            USE:        This is simply a light gray color assigned to this
                        variable to be used in the email's formatting.
                        If you do change it, keep in mind this will be used
                        in CSS style for the HTML format of the email.
            STEP #1:    Feel free to change it to whatever color you wish.
            STEP #2:    Copy the code to App.Formulas
                        fxLightGrayColor = "#e5e5e5";
            STEP #3:    Delete or comment out the use of the Set() function
        =================================================================== */
        Set(fxLightGrayColor, "#e5e5e5");
        // ==================================================================
        //
        /* ===================================================================
            VARIABLE 5 fxMaxUniqueErrorsPerSession
            ==================================================================
            USE:        Maximum number of unique error signatures to track
                        per session. This prevents unbounded memory growth
                        if many different errors occur.
                        Once this limit is reached, no more emails will be
                        sent (but errors are still counted if already tracked).
            STEP #1:    Adjust the number if needed (default: 50)
            STEP #2:    Copy the code to App.Formulas
                        fxMaxUniqueErrorsPerSession = 50;
            STEP #3:    Delete or comment out the use of the Set() function
        =================================================================== */
        Set(fxMaxUniqueErrorsPerSession, 50);
        // ==================================================================
        //
        /* ===================================================================
            VARIABLE 6 fxErrorKinds (REQUIRED - Add to App.Formulas)
            ==================================================================
            USE:        Lookup table of all Power Fx error kinds with their
                        descriptions. Used to provide detailed explanations
                        in error notification emails.
            STEP #1:    Copy the fxErrorKinds table to App.Formulas.
                        The full definition is provided in the companion file
                        or can be found at:
                        https://learn.microsoft.com/en-us/power-platform/power-fx/reference/function-iferror
            EXAMPLE:
                        fxErrorKinds = [
                            { KindName: "None", KindNumber: 0, Description: "There's no error." },
                            { KindName: "Sync", KindNumber: 1, Description: "An error was reported by the data source..." },
                            // ... etc
                        ];
        =================================================================== */
        /* ===================================================================
            COLLECTION 7 colAppErrors (UPDATED in v2.2)
            ==================================================================
            USE:        Stores UNIQUE errors with occurrence counts.
                        Each record represents one unique error signature,
                        with OccurrenceCount tracking how many times it happened.
            FIELDS:     {
                            Signature:          "",   // Unique key for dedup
                            Kind:               "",   // ErrorKind enum value
                            KindName:           "",   // Human-readable kind name
                            KindDescription:    "",   // Detailed explanation
                            Message:            "",
                            Source:             "",
                            Observed:           "",
                            HttpResponse:       "",
                            HttpStatusCode:     "",
                            FirstOccurrence:    "",   // When first seen
                            LastOccurrence:     "",   // When last seen
                            Screen:             "",
                            UserEmail:          "",
                            UsersName:          "",
                            OccurrenceCount:    0     // How many times
                        }
            NOTE:       This collection is managed automatically.
            DATABASE:   If storing to a data source, add these 15 fields.
        =================================================================== */


        /* ===================================================================

        The rest of this code may remain unmodified

        =================================================================== */
        With(
            {
                // Context variables for this error batch
                LightGrayColorHexBG:    "background-color:" & fxLightGrayColor & ";",
                ScreenName:             App.ActiveScreen.Name,
                MyUsersName:            User().FullName,
                MyUsersEmail:           User().Email,
                CurrentTimestamp:       Text(Now(), "MM/dd/yyyy hh:mm:ss.fff AM/PM")
            },
            // Process each error in AllErrors
            ForAll(
                AllErrors As Err,
                With(
                    {
                        // Create unique signature for this error
                        ThisSignature: Concatenate(
                            ScreenName, "||",
                            Text(Err.Kind), "||",
                            Text(Err.Source), "||",
                            Left(Text(Err.Message), 100)
                        ),
                        // Look up the error kind details from fxErrorKinds
                        ErrorKindInfo: LookUp(
                            fxErrorKinds,
                            KindName = Text(Err.Kind)
                        )
                    },
                    // Check if this signature already exists in our collection
                    With(
                        {
                            ExistingError: LookUp(colAppErrors, Signature = ThisSignature),
                            // Get description, fallback if not found
                            KindDesc: If(
                                !IsBlank(ErrorKindInfo),
                                ErrorKindInfo.Description,
                                "Unknown error kind. Check the Message field for more details."
                            ),
                            KindNameText: If(
                                !IsBlank(ErrorKindInfo),
                                ErrorKindInfo.KindName,
                                Text(Err.Kind)
                            )
                        },
                        If(
                            // ERROR ALREADY EXISTS - just increment the count
                            !IsBlank(ExistingError),
                            Patch(
                                colAppErrors,
                                ExistingError,
                                {
                                    OccurrenceCount: ExistingError.OccurrenceCount + 1,
                                    LastOccurrence: CurrentTimestamp
                                }
                            ),
                            // NEW ERROR - add to collection and send email
                            // First, add the new error record with kind details
                            Collect(
                                colAppErrors,
                                {
                                    Signature:          ThisSignature,
                                    Kind:               Err.Kind,
                                    KindName:           KindNameText,
                                    KindDescription:    KindDesc,
                                    Message:            Text(Err.Message),
                                    Source:             Text(Err.Source),
                                    Observed:           Text(Err.Observed),
                                    HttpResponse:       Text(Err.Details.HttpResponse),
                                    HttpStatusCode:     Text(Err.Details.HttpStatusCode),
                                    FirstOccurrence:    CurrentTimestamp,
                                    LastOccurrence:     CurrentTimestamp,
                                    Screen:             ScreenName,
                                    UserEmail:          MyUsersEmail,
                                    UsersName:          MyUsersName,
                                    OccurrenceCount:    1
                                }
                            );
                            // Then send email notification with FULL session report
                            If(
                                fxEnableErrorEmailNotifications &&
                                CountRows(colAppErrors) <= fxMaxUniqueErrorsPerSession,
                                IfError(
                                    Office365Outlook.SendEmailV2(
                                        // =============================================================
                                        // WHO TO SEND THE EMAIL TO
                                        // =============================================================
                                        fxErrorHandlerEmail,
                                        // =============================================================
                                        // SUBJECT OF EMAIL
                                        // =============================================================
                                        Concatenate(
                                            "[New Error #", Text(CountRows(colAppErrors)), "] ",
                                            fxApplicationName,
                                            " - ",
                                            MyUsersName
                                        ),
                                        // =============================================================
                                        // BODY - Full session report with ALL errors and counts
                                        // =============================================================
                                        $"<html><body style='font-family: Segoe UI, Arial, sans-serif;'>
                                            <h2 style='color:#c00; border-bottom:2px solid #c00; padding-bottom:10px;'>New Error Alert</h2>
                                            <table style='margin-bottom:20px;'>
                                                <tr><td style='padding-right:15px;'><strong>User:</strong></td><td>{MyUsersName} ({MyUsersEmail})</td></tr>
                                                <tr><td style='padding-right:15px;'><strong>Screen:</strong></td><td>{ScreenName}</td></tr>
                                                <tr><td style='padding-right:15px;'><strong>Time:</strong></td><td>{CurrentTimestamp}</td></tr>
                                            </table>

                                            <h3 style='background-color:#c00; color:white; padding:10px; margin-bottom:0;'>New Error Details</h3>
                                            <table style='width:100%; margin-bottom:20px; border-collapse:collapse;' border='1' cellpadding='10' cellspacing='0'>
                                                <tr style='{LightGrayColorHexBG}'><td style='width:150px;'><strong>Error Kind</strong></td><td><strong>{KindNameText}</strong></td></tr>
                                                <tr><td colspan='2' style='background-color:#fff8e8; padding:15px;'>
                                                    <em>{KindDesc}</em>
                                                </td></tr>
                                                <tr><td><strong>Source</strong></td><td>{Text(Err.Source)}</td></tr>
                                                <tr><td><strong>Message</strong></td><td style='color:#c00;'>{Text(Err.Message)}</td></tr>
                                                <tr><td><strong>Observed</strong></td><td>{Text(Err.Observed)}</td></tr>
                                                <tr><td><strong>Http Response</strong></td><td>{Text(Err.Details.HttpResponse)}</td></tr>
                                                <tr><td><strong>Http Status Code</strong></td><td>{Text(Err.Details.HttpStatusCode)}</td></tr>
                                            </table>

                                            <h3 style='background-color:#333; color:white; padding:10px; margin-bottom:0;'>Full Session Error Report ({CountRows(colAppErrors)} unique error(s))</h3>
                                            <p style='color:#666; margin-top:5px;'>This table shows ALL unique errors for this user's session and how many times each has occurred:</p>
                                            <table style='width:100%; border-collapse:collapse;' border='1' cellpadding='8' cellspacing='0'>
                                                <tr style='{LightGrayColorHexBG}'>
                                                    <th style='width:30px;'>#</th>
                                                    <th style='width:50px;'>Count</th>
                                                    <th>Screen</th>
                                                    <th>Kind</th>
                                                    <th>Source</th>
                                                    <th>Message</th>
                                                    <th>First Seen</th>
                                                </tr>" &
                                                Concat(
                                                    AddColumns(
                                                        colAppErrors,
                                                        RowNum, CountRows(Filter(colAppErrors, FirstOccurrence <= ThisRecord.FirstOccurrence))
                                                    ),
                                                    $"<tr style='{If(OccurrenceCount > 10, \"background-color:#fff0f0;\", \"\")}'>
                                                        <td style='text-align:center;'>{RowNum}</td>
                                                        <td style='text-align:center;{If(OccurrenceCount > 1, \"font-weight:bold; color:#c00;\", \"\")}'>{OccurrenceCount}x</td>
                                                        <td>{Screen}</td>
                                                        <td><strong>{KindName}</strong></td>
                                                        <td>{Source}</td>
                                                        <td>{Message}</td>
                                                        <td style='font-size:11px;'>{FirstOccurrence}</td>
                                                    </tr>
                                                    <tr style='background-color:#f9f9f9;'>
                                                        <td colspan='7' style='padding:8px 15px; font-size:12px; color:#666;'>
                                                            <em>{KindDescription}</em>
                                                        </td>
                                                    </tr>"
                                                ) & $"
                                                <tr style='{LightGrayColorHexBG}'>
                                                    <td colspan='7' style='padding:12px;'>
                                                        <strong>Total occurrences this session:</strong> {Sum(colAppErrors, OccurrenceCount)}
                                                    </td>
                                                </tr>
                                            </table>

                                            <hr style='margin-top:25px;'/>
                                            <p>
                                                <strong>Application:</strong> <a href='{fxApplicationURL}'>{fxApplicationName}</a>
                                            </p>
                                            <p style='color:#666; font-size:12px; background-color:#f5f5f5; padding:10px; border-radius:5px;'>
                                                You will only receive ONE email per unique error.
                                                Repeat occurrences are counted but do not trigger additional emails.
                                                This report shows {CountRows(colAppErrors)} unique error(s) with {Sum(colAppErrors, OccurrenceCount)} total occurrence(s).
                                            </p>
                                        </body></html>"
                                    ),
                                    Blank() // Swallow email error to prevent cascading failures
                                )
                            )
                        )
                    )
                )
            )
        );
        //
        /* ===================================================================
            As mentioned at the top of all this code,
            *IF* you'd like to store these in a data source,
            then uncomment out the two lines of code below.
            NOTE: The schema has changed in v2.2 - see COLLECTION 7 above
                  for the updated field list (15 fields now).
        =================================================================== */
        //Patch(PowerAppsErrors, colAppErrors);
        //Clear(colAppErrors);
        // ===================================================================
        //
        //                      END OF App.OnError
        //
        // ===================================================================
